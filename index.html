<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>แบบฟอร์มสำรวจข้อมูล DEM ของหน่วยงานรัฐในประเทศไทย</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      body {
        font-family: "Sarabun", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }
      select[multiple] {
        min-height: 3.5rem;
      }

      /* toggle-pill */
      .toggle-pill {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 54px;
        height: 22px;
        border-radius: 9999px;
        cursor: pointer;
        border: none;
        outline: none;
        transition: background-color 0.25s ease;
        padding: 0;
        background-color: #94a3b8;
      }

      .toggle-pill .toggle-knob {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #ffffff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        position: absolute;
        top: 3px;
        transition: left 0.25s ease, right 0.25s ease;
      }

      .toggle-label {
        display: inline-block;
        color: #ffffff;
        font-size: 10px;
        font-weight: 600;
        pointer-events: none;
        transition: margin 0.25s ease;
      }

      .toggle-pill[data-state="shown"] {
        background-color: #22c55e;
      }
      .toggle-pill[data-state="shown"] .toggle-knob {
        left: auto;
        right: 3px;
      }
      .toggle-pill[data-state="shown"] .toggle-label {
        margin-right: 14px;
        margin-left: 0;
      }

      .toggle-pill[data-state="hidden"] {
        background-color: #94a3b8;
      }
      .toggle-pill[data-state="hidden"] .toggle-knob {
        left: 3px;
        right: auto;
      }
      .toggle-pill[data-state="hidden"] .toggle-label {
        margin-left: 14px;
        margin-right: 0;
      }

      /* Tag Pill */
      .tag-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.1rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        background-color: #dbeafe;
        color: #1d4ed8;
        cursor: default;
        margin-right: 0.1rem;
        position: relative;
        z-index: 10;
      }
      .tag-pill .tag-text {
        margin-right: 0.25rem;
      }
      .tag-pill .tag-remove {
        font-weight: 600;
        cursor: pointer;
      }
    </style>
  </head>
  <body class="min-h-screen bg-slate-100">
    <div class="mx-auto max-w-5xl px-4 py-8 sm:px-6 lg:px-8">
      <div
        class="rounded-2xl bg-white shadow-lg px-4 py-5 sm:px-6 sm:py-6 lg:px-8"
      >
        <header class="border-b border-slate-200 pb-3 mb-5">
          <div class="flex items-center gap-4">
            <img
              src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Emblem_of_the_Office_of_the_National_Water_Resources.svg/1014px-Emblem_of_the_Office_of_the_National_Water_Resources.svg.png"
              alt="สทนช. Emblem"
              class="h-12 w-12 object-contain"
            />
            <div>
              <h1 class="text-xl sm:text-2xl font-semibold text-slate-800">
                แบบฟอร์มสำรวจขข้อมูลความสูงภูมิประเทศเชิงเลขของหน่วยงานรัฐในประเทศไทย
              </h1>
              <p class="mt-1 text-sm text-slate-600">
                ความสูงภูมิประเทศเชิงเลข (Digital Elevation Model, DEM)
              </p>
            </div>
          </div>
        </header>

        <form id="demSurveyForm" class="space-y-7" novalidate>
          <section>
            <h2
              class="text-lg font-semibold text-slate-800 mb-3 border-l-4 border-blue-600 pl-3"
            >
              ส่วนที่ 1 : ข้อมูลพื้นฐานของหน่วยงาน
            </h2>

            <div class="flex flex-col gap-3 sm:flex-row mb-2">
              <div class="sm:flex-1">
                <label
                  for="agencyName"
                  class="block text-sm font-medium text-slate-700 mb-0.5"
                  >ชื่อหน่วยงาน</label
                >
                <input
                  type="text"
                  id="agencyName"
                  name="agencyName"
                  class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="เช่น สำนักงานทรัพยากรน้ำแห่งชาติ (สทนช.)"
                />
              </div>

              <div class="sm:flex-1">
                <label
                  for="subUnit"
                  class="block text-sm font-medium text-slate-700 mb-0.5"
                  >หน่วยงานย่อย / สำนัก / กอง</label
                >
                <input
                  type="text"
                  id="subUnit"
                  name="subUnit"
                  class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="เช่น กองวิจัยและพัฒนา"
                />
              </div>
            </div>

            <fieldset
              class="border border-slate-300 rounded-lg p-3 bg-slate-50/30"
            >
              <legend class="px-2 text-sm font-semibold text-slate-700">
                ผู้ประสานงาน
              </legend>

              <div class="grid gap-3 sm:grid-cols-2">
                <div>
                  <label
                    for="contactName"
                    class="block text-sm font-medium text-slate-700"
                    >(คำนำหน้า) ชื่อ – สกุล</label
                  >
                  <input
                    type="text"
                    id="contactName"
                    name="contactName"
                    class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น นายสมชาย ใจดี"
                  />
                </div>

                <div>
                  <label
                    for="contactPosition"
                    class="block text-sm font-medium text-slate-700"
                    >ตำแหน่ง</label
                  >
                  <input
                    type="text"
                    id="contactPosition"
                    name="contactPosition"
                    class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น วิศวกร"
                  />
                </div>

                <div>
                  <label
                    for="contactPhone"
                    class="block text-sm font-medium text-slate-700"
                    >เบอร์โทรศัพท์</label
                  >
                  <input
                    type="tel"
                    id="contactPhone"
                    name="contactPhone"
                    inputmode="numeric"
                    class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น xx-xxx-xxxx หรือ xxx-xxx-xxxx"
                  />
                </div>

                <div>
                  <label
                    for="contactEmail"
                    class="block text-sm font-medium text-slate-700"
                    >อีเมล</label
                  >
                  <input
                    type="email"
                    id="contactEmail"
                    name="contactEmail"
                    class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น email@example.go.th"
                  />
                </div>
              </div>
            </fieldset>
          </section>

          <hr class="border-slate-200" />

          <section>
            <div
              class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4"
            >
              <div>
                <h2
                  class="text-lg font-semibold text-slate-800 border-l-4 border-blue-600 pl-3"
                >
                  ส่วนที่ 2 : รายการข้อมูล DEM ที่หน่วยงานมี
                </h2>
              </div>
              <button
                type="button"
                id="btnAddDemItem"
                class="inline-flex items-center justify-center rounded-lg border border-blue-600 bg-blue-600 px-2.5 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-blue-700 active:bg-blue-800 transition-colors gap-2"
              >
                <i class="fa-solid fa-file-circle-plus"></i>
                <span>เพิ่มชุดข้อมูล</span>
              </button>
            </div>

            <div id="demItemsContainer" class="space-y-5">
              <div
                class="dem-item rounded-xl border border-slate-300 bg-slate-50 px-3 py-4 sm:px-4 sm:py-4 relative"
              >
                <div
                  class="flex items-center justify-between gap-2 mb-3 border-b border-slate-200 pb-2"
                >
                  <h3
                    class="text-sm font-bold text-slate-700 flex items-center gap-2"
                  >
                    ชุดข้อมูลที่ 1
                    <button
                      type="button"
                      class="btn-remove-dem-item inline-flex items-center justify-center rounded-md border border-rose-300 bg-white px-1 py-0.5 text-xm font-medium text-rose-600 hover:bg-rose-500 hover:text-white transition shadow-sm hidden"
                      title="ลบชุดข้อมูลนี้"
                    >
                      <i class="fa-solid fa-xmark mr-1"> </i>
                      <span class="mr-1">ลบชุดข้อมูล</span>
                    </button>
                  </h3>
                  <div class="flex items-center gap-2">
                    <span
                      class="text-[11px] text-slate-500 hidden sm:inline"
                      >ทั้งหมด</span
                    >
                    <button
                      type="button"
                      class="item-toggle-all toggle-pill"
                      data-state="hidden"
                    >
                      <span class="toggle-knob"></span>
                      <span class="toggle-label">แสดง</span>
                    </button>
                  </div>
                </div>

                <div class="space-y-4">
                  <div
                    class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm"
                  >
                    <div
                      class="section-header flex items-center justify-between select-none"
                    >
                      <p class="text-sm font-semibold text-slate-800">
                        A. ข้อมูลทั่วไป
                      </p>
                      <button
                        type="button"
                        class="section-toggle toggle-pill"
                        data-state="shown"
                      >
                        <span class="toggle-knob"></span>
                        <span class="toggle-label">ซ่อน</span>
                      </button>
                    </div>
                    <div class="section-body space-y-3">
                      <div class="flex flex-col gap-3 sm:flex-row sm:items-start">
                        <div class="sm:flex-1">
                          <label
                            class="block text-sm font-medium text-slate-700 mb-1"
                            >1. ชื่อชุดข้อมูล DEM</label
                          >
                          <input
                            type="text"
                            name="demName[]"
                            class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="เช่น LiDAR พ.ศ. 2566 พื้นที่ลุ่มน้ำบางปะกง หรือชื่อโครงการจัดทำ DEM"
                          />
                        </div>
                        
                        <div class="sm:basis-[30%]">
                          <label
                            class="block text-sm font-medium text-slate-700 mb-1"
                            >2. แหล่งที่มา / ผู้ผลิตข้อมูล</label
                          >
                          <select
                            name="sourceType[]"
                            class="source-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="">-- เลือกแหล่งที่มา --</option>
                            <option value="self">หน่วยงานผลิตเอง</option>
                            <option value="rtsd">กรมแผนที่ทหาร</option>
                            <option value="gistda">GISTDA</option>
                            <option value="ldd">กรมพัฒนาที่ดิน</option>
                            <option value="other">อื่น ๆ (ระบุ)</option>
                          </select>
                          
                          <div class="source-other-wrapper mt-2 hidden">
                            <input
                              type="text"
                              name="sourceOther[]"
                              class="source-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ระบุหน่วยงาน / บริษัท"
                              disabled
                            />
                          </div>
                        </div>
                        
                        <div class="sm:basis-[10%] sm:max-w-[96px]">
                          <label
                            class="block text-sm font-medium text-slate-700 mb-1"
                            >3. ปีจัดทำ</label
                          >
                          <select
                            name="year[]"
                            class="year-select block w-full rounded-md border border-slate-300 bg-white px-2 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="">พ.ศ.</option>
                          </select>
                        </div>
                      </div>

                      <div>
                        <p
                          class="block text-sm font-medium text-slate-700 mb-1"
                        >
                          4. พื้นที่ครอบคลุม
                        </p>

                        <div class="space-y-1 text-sm">
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="coverageCountry[]"
                              value="thailand_all"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>ประเทศไทยทั้งหมด</span>
                          </label>

                          <div class="space-y-1">
                            <div class="inline-flex flex-wrap items-center gap-2">
                              <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input
                                  type="checkbox"
                                  class="toggle-basin h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                                />
                                <span>ลุ่มน้ำ (สามารถระบุได้หลายค่า)</span>
                              </label>
                              
                              <div class="basin-tags flex flex-wrap items-center gap-1"></div>
                            </div>
                            
                            <div class="basin-block mt-1 hidden">
                              <input
                                type="text"
                                class="basin-search mb-1 block w-full rounded-md border border-slate-300 bg-white px-3 py-1 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="พิมพ์เพื่อค้นหาลุ่มน้ำ"
                              />
                              <select
                                name="coverageBasin[]"
                                multiple
                                class="basin-select block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              >
                                </select>
                              <p class="mt-1 text-xm text-slate-500">
                                * Double Click เพื่อเพิ่ม/ลบ ลุ่มน้ำ
                              </p>
                              <input
                                type="hidden"
                                name="coverageBasinOther[]"
                                class="basin-other-input"
                              />
                            </div>
                          </div>

                          <div class="space-y-1">
                            <div class="inline-flex flex-wrap items-center gap-2">
                              <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input
                                  type="checkbox"
                                  class="toggle-province h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                                />
                                <span>จังหวัด (สามารถระบุได้หลายค่า)</span>
                              </label>
                              
                              <div class="province-tags flex flex-wrap items-center gap-1"></div>
                            </div>
                            
                            <div class="province-block mt-1 hidden">
                              <input
                                type="text"
                                class="province-search mb-1 block w-full rounded-md border border-slate-300 bg-white px-3 py-1 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="พิมพ์เพื่อค้นหาจังหวัด"
                              />
                              <select
                                name="coverageProvince[]"
                                multiple
                                class="province-select block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              >
                                </select>
                              <p class="mt-1 text-xm text-slate-500">
                                * Double Click เพื่อเพิ่ม/ลบ จังหวัด
                              </p>
                              <input
                                type="hidden"
                                name="coverageProvinceOther[]"
                                class="province-other-input"
                              />
                            </div>
                          </div>

                          <div class="space-y-1">
                            <label class="inline-flex items-center gap-2">
                              <input
                                type="checkbox"
                                class="toggle-local h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                              />
                              <span>พื้นที่เฉพาะจุด</span>
                            </label>
                            <div class="local-block mt-1 hidden">
                              <input
                                type="text"
                                name="coverageLocal[]"
                                class="local-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:cursor-not-allowed"
                                placeholder="เช่น เขตเทศบาลเมืองหาดใหญ่"
                                disabled
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm">
                    <div class="section-header flex items-center justify-between select-none">
                      <p class="text-sm font-semibold text-slate-800">B. รายละเอียดทางเทคนิค</p>
                      <button type="button" class="section-toggle toggle-pill" data-state="hidden">
                        <span class="toggle-knob"></span>
                        <span class="toggle-label">แสดง</span>
                      </button>
                    </div>
                    <div class="section-body space-y-3 hidden">
                        <div class="flex flex-col gap-3 lg:flex-row lg:items-start lg:flex-nowrap">
                            <div class="lg:flex-1 min-w-[160px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">5. Resolution</label>
                                <select name="resolution[]" class="resolution-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- เลือก Resolution --</option>
                                    <option value="30m">30 m</option>
                                    <option value="10m">10 m</option>
                                    <option value="5m">5 m</option>
                                    <option value="1m">1 m</option>
                                    <option value="lidar_sub1m">ต่ำกว่า 1 m (LiDAR / ระบุ)</option>
                                    <option value="other">อื่น ๆ (ระบุ)</option>
                                </select>
                                <div class="resolution-other-wrapper mt-2 hidden">
                                    <input type="text" name="resolutionOther[]" class="resolution-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น 0.5 m หรือรายละเอียดเพิ่มเติม" disabled />
                                </div>
                            </div>
                            <div class="lg:flex-1 min-w-[140px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">6. Vertical Accuracy (ม.)</label>
                                <input type="text" name="verticalAccuracy[]" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น 0.15" />
                            </div>
                            <div class="lg:flex-1 min-w-[140px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">7. Horizontal Accuracy (ม.)</label>
                                <input type="text" name="horizontalAccuracy[]" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น 0.30" />
                            </div>
                        </div>
                        <div class="flex flex-col gap-3 lg:flex-row lg:items-start lg:flex-nowrap">
                            <div class="lg:basis-1/2 min-w-[160px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">8. Vertical Datum</label>
                                <select name="verticalDatum[]" class="vertical-datum-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- เลือก Vertical Datum --</option>
                                    <option value="MSL">MSL</option>
                                    <option value="EGM96">EGM96</option>
                                    <option value="other">อื่น ๆ (ระบุ)</option>
                                </select>
                                <div class="vertical-datum-other-wrapper mt-2 hidden">
                                    <input type="text" name="verticalDatumOther[]" class="vertical-datum-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุ Datum อื่น ๆ" disabled />
                                </div>
                            </div>
                            <div class="lg:basis-1/2 min-w-[160px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">9. Coordinate System</label>
                                <select name="coordSys[]" class="coord-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- เลือก Coordinate System --</option>
                                    <option value="WGS84">WGS84</option>
                                    <option value="UTM47N">UTM 47N</option>
                                    <option value="UTM48N">UTM 48N</option>
                                    <option value="other">อื่น ๆ (ระบุ)</option>
                                </select>
                                <div class="coord-other-wrapper mt-2 hidden">
                                    <input type="text" name="coordSysOther[]" class="coord-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุระบบพิกัดอื่น ๆ" disabled />
                                </div>
                            </div>
                        </div>
                        <fieldset class="border border-slate-200 rounded-lg px-3 py-3">
                            <legend class="block text-sm font-medium text-slate-700">10. วิธีการจัดทำ DEM (สามารถระบุได้หลายค่า)</legend>
                            <div class="flex flex-wrap gap-3 text-sm">
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="demMethodLidar[]" value="LiDAR" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>LiDAR</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="demMethodUav[]" value="UAV Photogrammetry" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>UAV Photogrammetry</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="demMethodAlos[]" value="ALOS" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ALOS</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="demMethodSrtm[]" value="SRTM" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>SRTM</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="demMethodTanDEM[]" value="TanDEM-X" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>TanDEM-X</span></label>
                                <label class="inline-flex items-center gap-2 flex-1 min-w-[220px]">
                                    <input type="checkbox" name="demMethodOtherFlag[]" value="other" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>อื่น ๆ</span>
                                    <input type="text" name="demMethodOther[]" class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุวิธีการจัดทำ DEM">
                                </label>
                            </div>
                        </fieldset>
                    </div>
                  </div>

                  <div class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm">
                    <div class="section-header flex items-center justify-between select-none">
                      <p class="text-sm font-semibold text-slate-800">C. รูปแบบไฟล์และการเข้าถึง</p>
                      <button type="button" class="section-toggle toggle-pill" data-state="hidden">
                        <span class="toggle-knob"></span><span class="toggle-label">แสดง</span>
                      </button>
                    </div>
                    <div class="section-body space-y-3 hidden">
                        <fieldset class="border border-slate-200 rounded-lg px-3 py-3">
                            <legend class="block text-sm font-medium text-slate-700">11. File Format (สามารถระบุได้หลายค่า)</legend>
                            <div class="flex flex-wrap gap-3 text-sm">
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="formatGeoTIFF[]" value="GeoTIFF" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>GeoTIFF</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="formatIMG[]" value="IMG" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>IMG</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="formatASC[]" value="ASC" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ASC</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="formatLAS[]" value="LAS/LAZ" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>LAS/LAZ</span></label>
                                <label class="inline-flex items-center gap-2 flex-1 min-w-[220px]">
                                    <input type="checkbox" name="formatOtherFlag[]" value="other" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>อื่น ๆ</span>
                                    <input type="text" name="formatOther[]" class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุรูปแบบไฟล์อื่น ๆ">
                                </label>
                            </div>
                        </fieldset>
                        <div class="flex flex-col gap-3 md:flex-row md:items-start md:flex-wrap">
                            <div class="md:flex-1 md:min-w-[220px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">12. ขนาดไฟล์</label>
                                <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                    <div class="w-full sm:w-1/2">
                                        <input type="text" name="fileSize[]" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น 120" />
                                    </div>
                                    <div class="w-full sm:w-1/2">
                                        <select name="fileSizeUnit[]" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">-- หน่วย --</option><option value="TB">TB</option><option value="GB">GB</option><option value="MB">MB</option><option value="KB">KB</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="md:flex-1 md:min-w-[220px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">13. ลิขสิทธิ์</label>
                                <select name="license[]" class="license-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- เลือกลิขสิทธิ์ --</option><option value="open">Open Data</option><option value="internal">Internal</option><option value="exchange">Exchange</option><option value="restricted">Security Restricted</option><option value="other">อื่น ๆ (ระบุ)</option>
                                </select>
                                <div class="license-other-wrapper mt-2 hidden">
                                    <input type="text" name="licenseOther[]" class="license-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุประเภทลิขสิทธิ์อื่น ๆ" disabled />
                                </div>
                            </div>
                        </div>
                        <fieldset class="border border-slate-200 rounded-lg px-3 py-3">
                            <legend class="block text-sm font-medium text-slate-700">14. ช่องทางการเข้าถึง (สามารถระบุได้หลายค่า)</legend>
                            <div class="flex flex-wrap gap-3 text-sm">
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="accessWeb[]" value="web" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>เว็บดาวน์โหลด</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="accessOfficial[]" value="official_letter" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>หนังสือราชการ</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="accessMou[]" value="mou_nda" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>MOU / NDA</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="accessInternal[]" value="internal" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ภายในหน่วยงาน</span></label>
                                <label class="inline-flex items-center gap-2 flex-1 min-w-[220px]">
                                    <input type="checkbox" name="accessOtherFlag[]" value="other" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>อื่น ๆ</span>
                                    <input type="text" name="accessOther[]" class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุช่องทางอื่น ๆ">
                                </label>
                            </div>
                        </fieldset>
                    </div>
                  </div>

                  <div class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm">
                    <div class="section-header flex items-center justify-between select-none">
                      <p class="text-sm font-semibold text-slate-800">D. คุณภาพและการใช้งาน</p>
                      <button type="button" class="section-toggle toggle-pill" data-state="hidden">
                        <span class="toggle-knob"></span><span class="toggle-label">แสดง</span>
                      </button>
                    </div>
                    <div class="section-body space-y-3 hidden">
                        <fieldset class="border border-slate-200 rounded-lg px-3 py-3">
                            <legend class="block text-sm font-medium text-slate-700">15. QC/QA (สามารถระบุได้หลายค่า)</legend>
                            <div class="flex flex-wrap gap-3 text-sm">
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="qcNone[]" value="none" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ไม่มี</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="qcGcp[]" value="GCP" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>GCP</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="qcOtherDEM[]" value="compare_dem" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>เปรียบเทียบ DEM อื่น</span></label>
                                <label class="inline-flex items-center gap-2 flex-1 min-w-[220px]">
                                    <input type="checkbox" name="qcOtherFlag[]" value="other" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>อื่น ๆ</span>
                                    <input type="text" name="qcOther[]" class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุวิธี QC/QA อื่น ๆ">
                                </label>
                            </div>
                        </fieldset>
                        <fieldset class="border border-slate-200 rounded-lg px-3 py-3">
                            <legend class="block text-sm font-medium text-slate-700">16. การใช้งานหลัก (สามารถระบุได้หลายค่า)</legend>
                            <div class="flex flex-wrap gap-3 text-sm">
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="useFlood[]" value="flood" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>น้ำท่วม</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="useSubBasin[]" value="sub_basin" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ลุ่มน้ำย่อย</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="useUrbanPlan[]" value="urban_planning" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ผังเมือง</span></label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" name="useModel[]" value="models" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>แบบจำลอง RRI / HEC / MIKE</span></label>
                                <label class="inline-flex items-center gap-2 flex-1 min-w-[220px]">
                                    <input type="checkbox" name="useOtherFlag[]" value="other" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>อื่น ๆ</span>
                                    <input type="text" name="useOther[]" class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุการใช้งานอื่น ๆ">
                                </label>
                            </div>
                        </fieldset>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">17. หมายเหตุ</label>
                            <textarea name="remark[]" rows="1" style="resize: vertical; min-height: 2.5rem;" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุหมายเหตุเพิ่มเติม เช่น ปัญหาในการใช้งาน, ข้อจำกัด, แผนการปรับปรุงในอนาคต"></textarea>
                        </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <div
            class="flex flex-col gap-3 pt-4 border-t border-slate-200 sm:flex-row sm:items-center sm:justify-end"
          >
            <button
              type="reset"
              id="btnResetForm"
              class="inline-flex items-center justify-center rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 active:bg-slate-100"
            >
              ล้างค่า
            </button>
            <button
              type="submit"
              id="btnSubmitForm"
              class="inline-flex items-center justify-center rounded-lg border border-blue-600 bg-blue-600 px-5 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 active:bg-blue-800"
            >
              บันทึกแบบฟอร์ม
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="confirmModal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900/60 transition-opacity"
    >
      <div
        class="bg-white rounded-2xl shadow-xl w-full max-w-[400px] mx-4 p-6 transform transition-all"
      >
        <h3
          id="confirmTitle"
          class="text-xl font-bold text-gray-900 mb-2 text-left"
        >
          ยืนยันล้างข้อมูล
        </h3>
        <p
          id="confirmMessage"
          class="text-base text-gray-600 mb-8 text-left leading-relaxed"
        >
          คุณต้องการล้างค่าทั้งหมดในแบบฟอร์มหรือไม่?
        </p>
        <div class="flex justify-end gap-3">
          <button
            type="button"
            id="confirmCancel"
            class="px-5 py-2.5 rounded-lg border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 transition-colors"
          >
            ยกเลิก
          </button>
          <button
            type="button"
            id="confirmOk"
            class="px-5 py-2.5 rounded-lg bg-blue-600 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm transition-colors"
          >
            ยืนยัน
          </button>
        </div>
      </div>
    </div>

    <div
      id="successModal"
      class="fixed inset-0 z-[60] hidden items-center justify-center"
      aria-labelledby="modal-title"
      role="dialog"
      aria-modal="true"
    >
      <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"></div>
      <div class="relative z-10 w-full max-w-sm transform overflow-hidden rounded-2xl bg-white p-6 text-center shadow-2xl transition-all sm:p-8 scale-100">
        <div class="mx-auto mb-5 flex h-16 w-16 items-center justify-center rounded-full bg-green-100">
          <i class="fa-solid fa-check text-3xl text-green-600"></i>
        </div>
        <h3 class="mb-2 text-xl font-bold text-slate-800" id="modal-title">
          บันทึกข้อมูลสำเร็จ!
        </h3>
        <p class="mb-6 text-sm text-slate-500">
          ระบบได้ทำการบันทึกข้อมูลแบบฟอร์มของท่านเรียบร้อยแล้ว
        </p>
        <button
          type="button"
          id="successOk"
          class="inline-flex w-full justify-center rounded-xl bg-green-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-green-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600 transition-all duration-200"
        >
          ตกลง
        </button>
      </div>
    </div>

    <script>
      // ★★ ใส่ URL Web App ของ Apps Script ที่นี่ ★★
      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw8Wf9vZsQbksaG7dmtWxw2b26xzCxI0Rl1lTlWggIS_rlULBL-wkOjDgRBZuH_vWI5Lw/exec";
      
      const demContainer = document.getElementById("demItemsContainer");
      const btnAddDemItem = document.getElementById("btnAddDemItem");
      const form = document.getElementById("demSurveyForm");
      
      // -------------------- บังคับกรอก ส่วนที่ 1 (ข้อมูลหน่วยงาน) --------------------
      const requiredAgencyIds = [
        "agencyName",
        "subUnit",
        "contactName",
        "contactPosition",
        "contactPhone",
        "contactEmail",
      ];
      requiredAgencyIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.required = true;
      });
      
      // -------------------- ฟังก์ชันจัดการ Input ตัวเลข (ใช้ร่วมกันทั้งเบอร์โทรและทศนิยม) --------------------
      function setupNumericField(input, type = 'decimal') {
        if (!input) return;

        // 1. ตั้งค่า Keyboard บนมือถือ
        input.setAttribute("inputmode", type === 'decimal' ? "decimal" : "numeric");

        // 2. ดักจับตอนพิมพ์ (Input)
        input.addEventListener("input", function() {
            let val = this.value;

            if (type === 'decimal') {
                // --- กรณีทศนิยม (ข้อ 6, 7, 12) ---
                val = val.replace(/[^0-9.]/g, ""); // ลบตัวอักษรอื่น
                const parts = val.split('.');
                if (parts.length > 2) {
                    val = parts[0] + '.' + parts.slice(1).join(''); // ป้องกันจุดซ้ำ
                }
            } else {
                // --- กรณีเบอร์โทร / จำนวนเต็ม ---
                val = val.replace(/\D/g, ""); // ลบทุกอย่างที่ไม่ใช่ตัวเลข
            }

            this.value = val;
            if (typeof clearError === "function") clearError(this);

            // Validation เฉพาะของเบอร์โทร
            if (type === 'phone') {
                 if (val.length > 0 && (val.length < 9 || val.length > 10)) {
                     this.setCustomValidity("กรุณากรอก 9-10 หลัก");
                 } else {
                     this.setCustomValidity("");
                 }
            }
        });

        // 3. ดักจับตอน Focus (คลิกที่ช่อง) -> ลบขีดออกเพื่อให้แก้ตัวเลขง่าย
        input.addEventListener("focus", function() {
             if (type === 'decimal') {
                 this.value = this.value.replace(/[^0-9.]/g, "");
             } else {
                 this.value = this.value.replace(/\D/g, "");
             }
        });
        
        // 4. ดักจับตอน Blur (พิมพ์เสร็จ) -> จัดรูปแบบเฉพาะเบอร์โทร
        input.addEventListener("blur", function() {
            if (type === 'phone') {
                let digits = this.value.replace(/\D/g, "");
                // จัดรูปแบบขีด (-) อัตโนมัติ
                if (digits.length === 9) {
                     this.value = digits.replace(/^(\d{2})(\d{3})(\d{4})$/, "$1-$2-$3");
                } else if (digits.length === 10) {
                     this.value = digits.replace(/^(\d{3})(\d{3})(\d{4})$/, "$1-$2-$3");
                }
            }
        });
      }

      // เรียกใช้กับเบอร์โทรศัพท์ (Section 1)
      setupNumericField(document.getElementById("contactPhone"), 'phone');
      
      // -------------------- Confirm Modal --------------------
      const confirmModal = document.getElementById("confirmModal");
      const confirmTitle = document.getElementById("confirmTitle");
      const confirmMessage = document.getElementById("confirmMessage");
      const confirmCancel = document.getElementById("confirmCancel");
      const confirmOk = document.getElementById("confirmOk");
      let confirmCallback = null;
      
      function openConfirmModal(title, message, onConfirm) {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmCallback = onConfirm;
        confirmModal.classList.remove("hidden");
        confirmModal.classList.add("flex");
      }
      
      function closeConfirmModal() {
        confirmModal.classList.add("hidden");
        confirmModal.classList.remove("flex");
        confirmCallback = null;
      }
      
      confirmCancel.addEventListener("click", closeConfirmModal);
      confirmOk.addEventListener("click", () => {
        if (typeof confirmCallback === "function") {
          confirmCallback();
        }
        closeConfirmModal();
      });
      confirmModal.addEventListener("click", (e) => {
        if (e.target === confirmModal) {
          closeConfirmModal();
        }
      });
      
      // -------------------- Success Modal Control --------------------
      const successModal = document.getElementById("successModal");
      const successOk = document.getElementById("successOk");

      function openSuccessModal() {
        if (!successModal) return;
        successModal.classList.remove("hidden");
        successModal.classList.add("flex");
        if(successOk) successOk.focus();
      }

      function closeSuccessModal() {
        if (!successModal) return;
        successModal.classList.add("hidden");
        successModal.classList.remove("flex");
      }

      if (successOk) {
        successOk.addEventListener("click", closeSuccessModal);
      }
      if (successModal) {
        successModal.addEventListener("click", (e) => {
           if (e.target === successModal) { 
             closeSuccessModal(); 
           }
        });
      }
      
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeConfirmModal();
          closeSuccessModal();
        }
      });
      
      // -------------------- Year Select (2539–2568) --------------------
      function populateYearSelects() {
        const selects = document.querySelectorAll(".year-select");
        const startBE = 2539;
        const endBE = 2568;
      
        selects.forEach((sel) => {
          if (sel.options.length > 1) return;
          for (let y = endBE; y >= startBE; y--) {
            const opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y.toString();
            sel.appendChild(opt);
          }
          sel.classList.add("text-sm");
        });
      }
      
      // -------------------- DEM Index --------------------
      function updateDemIndexes() {
        const items = demContainer.querySelectorAll(".dem-item");
        items.forEach((item, index) => {
          const idx = index + 1;
          const badge = item.querySelector(".dem-index");
          if (badge) badge.style.display = "none";
      
          const header = item.querySelector("h3");
          if (header) {
            let titleSpan = header.querySelector(".dem-title-text");
            if (!titleSpan) {
              titleSpan = document.createElement("span");
              titleSpan.className = "dem-title-text";
              titleSpan.style.marginLeft = "4px";
              const toRemove = [];
              header.childNodes.forEach((node) => {
                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                  toRemove.push(node);
                }
              });
              toRemove.forEach((n) => header.removeChild(n));
              const removeBtn = header.querySelector(".btn-remove-dem-item");
              if (removeBtn) {
                header.insertBefore(titleSpan, removeBtn);
              } else {
                header.appendChild(titleSpan);
              }
            }
            titleSpan.textContent = `ชุดข้อมูลที่ ${idx}`;
          }
      
          const removeBtn = item.querySelector(".btn-remove-dem-item");
          if (removeBtn) {
            if (items.length === 1) {
              removeBtn.classList.add("hidden");
            } else {
              removeBtn.classList.remove("hidden");
            }
            removeBtn.classList.add("bg-rose-600", "text-white", "border", "border-rose-600", "hover:bg-rose-700");
            removeBtn.classList.remove("bg-white");
          }
        });
      }
      
      // -------------------- Section Toggles --------------------
      function setSectionVisibility(card, visible) {
        const body = card.querySelector(".section-body");
        const toggleBtn = card.querySelector(".section-toggle");
        if (!body || !toggleBtn) return;
        const label = toggleBtn.querySelector(".toggle-label");
        if (visible) {
          body.classList.remove("hidden");
          toggleBtn.dataset.state = "shown";
          if (label) label.textContent = "ซ่อน";
        } else {
          body.classList.add("hidden");
          toggleBtn.dataset.state = "hidden";
          if (label) label.textContent = "แสดง";
        }
      }
      
      function attachSectionToggles(item) {
        const cards = item.querySelectorAll(".section-card");
        cards.forEach((card, idx) => {
          setSectionVisibility(card, idx === 0);
        });
      
        cards.forEach((card) => {
          const body = card.querySelector(".section-body");
          const toggleBtn = card.querySelector(".section-toggle");
          if (!body || !toggleBtn) return;
          toggleBtn.addEventListener("click", () => {
            const currentlyHidden = body.classList.contains("hidden");
            setSectionVisibility(card, currentlyHidden);
          });
        });
      
        const itemToggle = item.querySelector(".item-toggle-all");
        if (itemToggle) {
          const labelAll = itemToggle.querySelector(".toggle-label");
          const refreshItemToggleState = () => {
            const innerCards = item.querySelectorAll(".section-card");
            const anyHidden = Array.from(innerCards).some((c) =>
              c.querySelector(".section-body").classList.contains("hidden")
            );
            itemToggle.dataset.state = anyHidden ? "hidden" : "shown";
            if (labelAll) labelAll.textContent = anyHidden ? "แสดง" : "ซ่อน";
          };
          refreshItemToggleState();
          itemToggle.addEventListener("click", () => {
            const makeVisible = itemToggle.dataset.state === "hidden";
            const innerCards = item.querySelectorAll(".section-card");
            innerCards.forEach((card) =>
              setSectionVisibility(card, makeVisible)
            );
            itemToggle.dataset.state = makeVisible ? "shown" : "hidden";
            if (labelAll) labelAll.textContent = makeVisible ? "ซ่อน" : "แสดง";
          });
          cards.forEach((card) => {
            const btn = card.querySelector(".section-toggle");
            if (!btn) return;
            btn.addEventListener("click", () => {
              setTimeout(refreshItemToggleState, 0);
            });
          });
        }
      }
      
      // -------------------- Reference data --------------------
      let REF_DATA = null;
      function populateSelectOptions(selectEl, values) {
        if (!selectEl) return;
        const currentSelected = Array.from(selectEl.options)
          .filter((o) => o.selected)
          .map((o) => o.value);
        selectEl.innerHTML = "";
        (values || []).forEach((val) => {
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          if (currentSelected.includes(val)) opt.selected = true;
          selectEl.appendChild(opt);
        });
      }
      
      function applyReferenceDataToAllItems() {
        if (!REF_DATA) return;
        const basins = REF_DATA.basins || [];
        const provinces = REF_DATA.provinces || [];
        document
          .querySelectorAll(".basin-select")
          .forEach((sel) => populateSelectOptions(sel, basins));
        document
          .querySelectorAll(".province-select")
          .forEach((sel) => populateSelectOptions(sel, provinces));
      }
      
      async function initReferenceDropdowns() {
        try {
          const resp = await fetch(APPS_SCRIPT_URL + "?action=getReferenceData");
          const data = await resp.json();
          REF_DATA = data || { basins: [], provinces: [] };
          applyReferenceDataToAllItems();
        } catch (err) {
          console.error("getReferenceData error", err);
        }
      }
      
      // -------------------- Attach handlers (Main Logic) --------------------
      function markSectionARequired(item) {
        const demName = item.querySelector('input[name="demName[]"]');
        const sourceSelect = item.querySelector('select[name="sourceType[]"]');
        const yearSelect = item.querySelector('select[name="year[]"]');
        if (demName) demName.required = true;
        if (sourceSelect) sourceSelect.required = true;
        if (yearSelect) yearSelect.required = true;
      }
      
      function attachOtherFieldHandlers(item) {
        if (!item) return;

        attachSectionToggles(item);
        markSectionARequired(item);

        // ★★★ บังคับกรอกตัวเลขข้อ 6, 7, 12 ★★★
        const verticalAccInput = item.querySelector('input[name="verticalAccuracy[]"]');
        const horizontalAccInput = item.querySelector('input[name="horizontalAccuracy[]"]');
        const fileSizeInput = item.querySelector('input[name="fileSize[]"]');

        setupNumericField(verticalAccInput, 'decimal');
        setupNumericField(horizontalAccInput, 'decimal');
        setupNumericField(fileSizeInput, 'decimal');

        // ---- Tag Stack Helper ----
        function setupTagStack(selectEl, tagsContainer, hiddenInput) {
          if (!selectEl || !tagsContainer || !hiddenInput) return;
          let values = [];
          function renderTags() {
            tagsContainer.innerHTML = "";
            values.forEach((val) => {
              const span = document.createElement("span");
              span.className = "tag-pill";
              span.dataset.value = val;
              span.innerHTML = `<span class="tag-text">${val}</span><span class="tag-remove">×</span>`;
              tagsContainer.appendChild(span);
            });
            hiddenInput.value = values.join(", ");
          }
          function addValue(val) {
            const v = (val || "").trim();
            if (!v || values.includes(v)) return;
            values.push(v);
            renderTags();
          }
          function removeValue(val) {
            const idx = values.indexOf(val);
            if (idx === -1) return;
            values.splice(idx, 1);
            renderTags();
          }
          selectEl.addEventListener("dblclick", () => {
            const opt = selectEl.options[selectEl.selectedIndex];
            const text = opt ? opt.textContent.trim() : "";
            if (!text) return;
            if (values.includes(text)) {
              removeValue(text);
            } else {
              addValue(text);
            }
          });
          tagsContainer.addEventListener("click", (e) => {
            const removeBtn = e.target.closest(".tag-remove");
            if (!removeBtn) return;
            e.preventDefault();
            e.stopPropagation();
            const pill = removeBtn.closest(".tag-pill");
            if (!pill) return;
            const v = pill.dataset.value;
            removeValue(v);
          });
        }

        // ---- Search Filter Helper ----
        function setupSearchFilter(selectEl, searchInput) {
          if (!selectEl || !searchInput) return;
          searchInput.addEventListener("input", () => {
            const term = searchInput.value.trim().toLowerCase();
            const opts = Array.from(selectEl.options);
            opts.forEach((opt, idx) => {
              if (idx === 0 && opt.value === "") {
                opt.hidden = false;
                return;
              }
              if (!term) {
                opt.hidden = false;
              } else {
                const match = opt.textContent.toLowerCase().includes(term);
                opt.hidden = !match;
              }
            });
          });
        }

        const sourceSelect = item.querySelector(".source-select");
        const sourceOtherWrapper = item.querySelector(".source-other-wrapper");
        const sourceOtherInput = item.querySelector(".source-other-input");
        if (sourceSelect && sourceOtherWrapper && sourceOtherInput) {
          sourceSelect.addEventListener("change", () => {
            const show = sourceSelect.value === "other";
            sourceOtherWrapper.classList.toggle("hidden", !show);
            sourceOtherInput.disabled = !show;
            if (show) sourceOtherInput.focus();
            else sourceOtherInput.value = "";
          });
          const show = sourceSelect.value === "other";
          sourceOtherWrapper.classList.toggle("hidden", !show);
          sourceOtherInput.disabled = !show;
        }

        const resSelect = item.querySelector(".resolution-select");
        const resOtherWrapper = item.querySelector(".resolution-other-wrapper");
        const resOtherInput = item.querySelector(".resolution-other-input");
        if (resSelect && resOtherWrapper && resOtherInput) {
          const updateRes = () => {
            const show =
              resSelect.value === "lidar_sub1m" || resSelect.value === "other";
            resOtherWrapper.classList.toggle("hidden", !show);
            resOtherInput.disabled = !show;
            if (show) resOtherInput.focus();
            else resOtherInput.value = "";
          };
          resSelect.addEventListener("change", updateRes);
          updateRes();
        }

        const vDatumSelect = item.querySelector(".vertical-datum-select");
        const vDatumWrapper = item.querySelector(".vertical-datum-other-wrapper");
        const vDatumInput = item.querySelector(".vertical-datum-other-input");
        if (vDatumSelect && vDatumWrapper && vDatumInput) {
          const updateVD = () => {
            const show = vDatumSelect.value === "other";
            vDatumWrapper.classList.toggle("hidden", !show);
            vDatumInput.disabled = !show;
            if (show) vDatumInput.focus();
            else vDatumInput.value = "";
          };
          vDatumSelect.addEventListener("change", updateVD);
          updateVD();
        }

        const coordSelect = item.querySelector(".coord-select");
        const coordWrapper = item.querySelector(".coord-other-wrapper");
        const coordInput = item.querySelector(".coord-other-input");
        if (coordSelect && coordWrapper && coordInput) {
          const updateCoord = () => {
            const show = coordSelect.value === "other";
            coordWrapper.classList.toggle("hidden", !show);
            coordInput.disabled = !show;
            if (show) coordInput.focus();
            else coordInput.value = "";
          };
          coordSelect.addEventListener("change", updateCoord);
          updateCoord();
        }

        const licSelect = item.querySelector(".license-select");
        const licWrapper = item.querySelector(".license-other-wrapper");
        const licInput = item.querySelector(".license-other-input");
        if (licSelect && licWrapper && licInput) {
          const updateLic = () => {
            const show = licSelect.value === "other";
            licWrapper.classList.toggle("hidden", !show);
            licInput.disabled = !show;
            if (show) licInput.focus();
            else licInput.value = "";
          };
          licSelect.addEventListener("change", updateLic);
          updateLic();
        }

        // พื้นที่ครอบคลุม
        const coverageCountryCb = item.querySelector('input[name="coverageCountry[]"]');
        const basinToggle = item.querySelector(".toggle-basin");
        const provinceToggle = item.querySelector(".toggle-province");
        const localToggle = item.querySelector(".toggle-local");
        const basinBlock = item.querySelector(".basin-block");
        const provinceBlock = item.querySelector(".province-block");
        const localBlock = item.querySelector(".local-block");
        const localInput = item.querySelector(".local-input");
        const basinTags = item.querySelector(".basin-tags");
        const basinHidden = item.querySelector(".basin-other-input");
        const provinceTags = item.querySelector(".province-tags");
        const provinceHidden = item.querySelector(".province-other-input");

        function updateCoverageGroup() {
          const isCountryChecked = coverageCountryCb && coverageCountryCb.checked;
          if (isCountryChecked) {
            if (basinToggle) { basinToggle.checked = false; basinToggle.disabled = true; }
            if (provinceToggle) { provinceToggle.checked = false; provinceToggle.disabled = true; }
            if (localToggle) { localToggle.checked = false; localToggle.disabled = true; }
            if (basinBlock) basinBlock.classList.add("hidden");
            if (provinceBlock) provinceBlock.classList.add("hidden");
            if (localBlock) localBlock.classList.add("hidden");
            if (basinTags) basinTags.innerHTML = "";
            if (basinHidden) basinHidden.value = "";
            if (provinceTags) provinceTags.innerHTML = "";
            if (provinceHidden) provinceHidden.value = "";
            if (localInput) { localInput.value = ""; localInput.disabled = true; }
          } else {
            if (basinToggle) basinToggle.disabled = false;
            if (provinceToggle) provinceToggle.disabled = false;
            if (localToggle) localToggle.disabled = false;
            if (basinBlock && basinToggle) {
              basinBlock.classList.toggle("hidden", !basinToggle.checked);
            }
            if (provinceBlock && provinceToggle) {
              provinceBlock.classList.toggle("hidden", !provinceToggle.checked);
            }
            if (localBlock && localInput && localToggle) {
              const showLocal = localToggle.checked;
              localBlock.classList.toggle("hidden", !showLocal);
              localInput.disabled = !showLocal;
              if (!showLocal) localInput.value = "";
            }
          }
        }

        if (coverageCountryCb) coverageCountryCb.addEventListener("change", updateCoverageGroup);
        if (basinToggle) basinToggle.addEventListener("change", updateCoverageGroup);
        if (provinceToggle) provinceToggle.addEventListener("change", updateCoverageGroup);
        if (localToggle) localToggle.addEventListener("change", updateCoverageGroup);

        const basinSelect = item.querySelector(".basin-select");
        const provinceSelect = item.querySelector(".province-select");
        setupTagStack(basinSelect, basinTags, basinHidden);
        setupTagStack(provinceSelect, provinceTags, provinceHidden);

        const basinSearch = item.querySelector(".basin-search");
        const provinceSearch = item.querySelector(".province-search");
        setupSearchFilter(basinSelect, basinSearch);
        setupSearchFilter(provinceSelect, provinceSearch);

        function setupOtherWithFlag(itm, flagName, inputName) {
            const flag = itm.querySelector(`input[name="${flagName}"]`);
            const input = itm.querySelector(`input[name="${inputName}"]`);
            if (!flag || !input) return;
            const update = () => {
                const on = flag.checked;
                input.disabled = !on;
                if (!on) input.value = "";
            };
            flag.addEventListener("change", update);
            update();
        }

        setupOtherWithFlag(item, "demMethodOtherFlag[]", "demMethodOther[]");
        setupOtherWithFlag(item, "formatOtherFlag[]", "formatOther[]");
        setupOtherWithFlag(item, "accessOtherFlag[]", "accessOther[]");
        setupOtherWithFlag(item, "qcOtherFlag[]", "qcOther[]");
        setupOtherWithFlag(item, "useOtherFlag[]", "useOther[]");

        const removeBtn = item.querySelector(".btn-remove-dem-item");
        if (removeBtn) {
          removeBtn.addEventListener("click", () => {
            item.remove();
            updateDemIndexes();
          });
        }
        updateCoverageGroup();
      }
      
      const firstItem = demContainer.querySelector(".dem-item");
      attachOtherFieldHandlers(firstItem);
      populateYearSelects();
      updateDemIndexes();
      initReferenceDropdowns();
      
      btnAddDemItem.addEventListener("click", () => {
        const first = demContainer.querySelector(".dem-item");
        const clone = first.cloneNode(true);
        clone.querySelectorAll("input, textarea, select").forEach((el) => {
          if (el.tagName === "SELECT") {
            el.selectedIndex = 0;
          } else if (el.type === "checkbox" || el.type === "radio") {
            el.checked = false;
            el.disabled = false;
          } else {
            el.value = "";
          }
          if (el.classList.contains("local-input")) {
            el.disabled = true;
          }
        });
        clone.querySelectorAll(".source-other-wrapper, .resolution-other-wrapper, .vertical-datum-other-wrapper, .coord-other-wrapper, .license-other-wrapper").forEach((wrap) => wrap.classList.add("hidden"));
        clone.querySelectorAll(".source-other-input, .resolution-other-input, .vertical-datum-other-input, .coord-other-input, .license-other-input").forEach((inp) => {
            inp.disabled = true;
            inp.value = "";
        });
        clone.querySelectorAll(".basin-block, .province-block").forEach((b) => b.classList.add("hidden"));
        const cloneLocalBlock = clone.querySelector(".local-block");
        const cloneLocalInput = clone.querySelector(".local-input");
        const cloneLocalToggle = clone.querySelector(".toggle-local");
        if (cloneLocalBlock && cloneLocalInput && cloneLocalToggle) {
          cloneLocalBlock.classList.add("hidden");
          cloneLocalInput.disabled = true;
          cloneLocalInput.value = "";
          cloneLocalToggle.checked = false;
        }
        clone.querySelectorAll(".basin-tags, .province-tags").forEach((c) => (c.innerHTML = ""));
        clone.querySelectorAll(".basin-other-input, .province-other-input").forEach((inp) => (inp.value = ""));
        const basinSearch = clone.querySelector(".basin-search");
        const basinSelect = clone.querySelector(".basin-select");
        if (basinSearch) basinSearch.value = "";
        if (basinSelect) {
          Array.from(basinSelect.options).forEach((opt) => (opt.hidden = false));
        }
        const provinceSearch = clone.querySelector(".province-search");
        const provinceSelect = clone.querySelector(".province-select");
        if (provinceSearch) provinceSearch.value = "";
        if (provinceSelect) {
          Array.from(provinceSelect.options).forEach((opt) => (opt.hidden = false));
        }
        demContainer.appendChild(clone);
        attachOtherFieldHandlers(clone);
        populateYearSelects();
        updateDemIndexes();
        applyReferenceDataToAllItems();
      });
      
      const resetBtn = document.getElementById("btnResetForm");
      resetBtn.addEventListener("click", (e) => {
        e.preventDefault();
        openConfirmModal(
          "ยืนยันล้างข้อมูล",
          "คุณต้องการล้างค่าทั้งหมดในแบบฟอร์มหรือไม่?",
          () => {
            form.reset();
            const items = demContainer.querySelectorAll(".dem-item");
            items.forEach((item, idx) => {
              if (idx > 0) {
                item.remove();
              }
            });
            const first = demContainer.querySelector(".dem-item");
            if (!first) return;
            const basinBlock = first.querySelector(".basin-block");
            const provinceBlock = first.querySelector(".province-block");
            const basinTags = first.querySelector(".basin-tags");
            const provinceTags = first.querySelector(".province-tags");
            const basinHidden = first.querySelector(".basin-other-input");
            const provinceHidden = first.querySelector(".province-other-input");
            const localInput = first.querySelector(".local-input");
            const localToggle = first.querySelector(".toggle-local");
            const localBlock = first.querySelector(".local-block");
            const basinSearch = first.querySelector(".basin-search");
            const basinSelect = first.querySelector(".basin-select");
            const provinceSearch = first.querySelector(".province-search");
            const provinceSelect = first.querySelector(".province-select");
      
            if (basinBlock) basinBlock.classList.add("hidden");
            if (provinceBlock) provinceBlock.classList.add("hidden");
            if (basinTags) basinTags.innerHTML = "";
            if (provinceTags) provinceTags.innerHTML = "";
            if (basinHidden) basinHidden.value = "";
            if (provinceHidden) provinceHidden.value = "";
            if (localBlock) localBlock.classList.add("hidden");
            if (localInput) {
              localInput.value = "";
              localInput.disabled = true;
            }
            if (localToggle) localToggle.checked = false;
            if (basinSearch) basinSearch.value = "";
            if (basinSelect) {
              Array.from(basinSelect.options).forEach((opt) => (opt.hidden = false));
            }
            if (provinceSearch) provinceSearch.value = "";
            if (provinceSelect) {
              Array.from(provinceSelect.options).forEach((opt) => (opt.hidden = false));
            }
            attachOtherFieldHandlers(first);
            populateYearSelects();
            updateDemIndexes();
            applyReferenceDataToAllItems();
          }
        );
      });
      
      function getCheckedValues(container, selector, excludeOther) {
        let vals = Array.from(
          container.querySelectorAll(selector + ":checked")
        ).map((el) => el.value);
        if (excludeOther) {
          vals = vals.filter((v) => {
            if (!v) return false;
            const t = v.toString().toLowerCase().replace(/\s+/g, "");
            return t !== "other" && t !== "อื่นๆ" && t !== "อื่นๆระบุ" && t !== "อื่นๆ(ระบุ)";
          });
        }
        return vals;
      }
      
      function collectFormData() {
        const agency = {
          agencyName: document.getElementById("agencyName").value.trim(),
          subUnit: document.getElementById("subUnit").value.trim(),
          contactName: document.getElementById("contactName").value.trim(),
          contactPosition: document.getElementById("contactPosition").value.trim(),
          contactPhone: document.getElementById("contactPhone").value.trim(),
          contactEmail: document.getElementById("contactEmail").value.trim(),
        };
        const items = [];
        const demItems = demContainer.querySelectorAll(".dem-item");
        demItems.forEach((item) => {
          const itemData = {};
          itemData.demName = item.querySelector('input[name="demName[]"]')?.value.trim() || "";
          const sourceSelect = item.querySelector('select[name="sourceType[]"]');
          const sourceOtherInput = item.querySelector('input[name="sourceOther[]"]');
          if (sourceSelect) {
            if (sourceSelect.value === "other") {
              itemData.sourceType = (sourceOtherInput?.value || "").trim();
            } else {
              itemData.sourceType = sourceSelect.value || "";
            }
          } else {
            itemData.sourceType = "";
          }
          itemData.year = item.querySelector('select[name="year[]"]')?.value || "";

          // ★★★ แก้ไข: แปลงค่า 'thailand_all' เป็น 'ทั่วประเทศ' ★★★
          const rawCountry = getCheckedValues(item, 'input[name="coverageCountry[]"]', false);
          itemData.coverageCountry = rawCountry.map(val => 
              val === 'thailand_all' ? 'ทั่วประเทศ' : val
          );
          // ★★★ ลบบรรทัดที่เคยเขียนทับค่านี้ทิ้งไปแล้ว ★★★

          itemData.coverageBasinTags = item.querySelector(".basin-other-input")?.value.trim() || "";
          itemData.coverageProvinceTags = item.querySelector(".province-other-input")?.value.trim() || "";
          itemData.coverageLocal = item.querySelector('input[name="coverageLocal[]"]')?.value.trim() || "";
          
          const resSelect = item.querySelector('select[name="resolution[]"]');
          const resOtherInput = item.querySelector('input[name="resolutionOther[]"]');
          if (resSelect) {
            if (resSelect.value === "other" || resSelect.value === "lidar_sub1m") {
              itemData.resolution = (resOtherInput?.value || "").trim();
            } else {
              itemData.resolution = resSelect.value || "";
            }
          } else {
            itemData.resolution = "";
          }
          itemData.verticalAccuracy = item.querySelector('input[name="verticalAccuracy[]"]')?.value || "";
          itemData.horizontalAccuracy = item.querySelector('input[name="horizontalAccuracy[]"]')?.value || "";
          const vDatumSelect = item.querySelector('select[name="verticalDatum[]"]');
          const vDatumInput = item.querySelector('input[name="verticalDatumOther[]"]');
          if (vDatumSelect) {
            if (vDatumSelect.value === "other") {
              itemData.verticalDatum = (vDatumInput?.value || "").trim();
            } else {
              itemData.verticalDatum = vDatumSelect.value || "";
            }
          } else {
            itemData.verticalDatum = "";
          }
          const coordSelect = item.querySelector('select[name="coordSys[]"]');
          const coordInput = item.querySelector('input[name="coordSysOther[]"]');
          if (coordSelect) {
            if (coordSelect.value === "other") {
              itemData.coordSys = (coordInput?.value || "").trim();
            } else {
              itemData.coordSys = coordSelect.value || "";
            }
          } else {
            itemData.coordSys = "";
          }
          itemData.demMethods = getCheckedValues(item, 'input[name^="demMethod"]', true);
          const demMethodOtherText = item.querySelector('input[name="demMethodOther[]"]')?.value.trim() || "";
          if (demMethodOtherText) itemData.demMethods.push(demMethodOtherText);
          itemData.fileFormats = getCheckedValues(item, 'input[name^="format"]', true);
          const formatOtherText = item.querySelector('input[name="formatOther[]"]')?.value.trim() || "";
          if (formatOtherText) itemData.fileFormats.push(formatOtherText);
          itemData.fileSize = item.querySelector('input[name="fileSize[]"]')?.value || "";
          itemData.fileSizeUnit = item.querySelector('select[name="fileSizeUnit[]"]')?.value || "";
          const licSelect = item.querySelector('select[name="license[]"]');
          const licInput = item.querySelector('input[name="licenseOther[]"]');
          if (licSelect) {
            if (licSelect.value === "other") {
              itemData.license = (licInput?.value || "").trim();
            } else {
              itemData.license = licSelect.value || "";
            }
          } else {
            itemData.license = "";
          }
          itemData.accessChannels = getCheckedValues(item, 'input[name^="access"]', true);
          itemData.accessOther = item.querySelector('input[name="accessOther[]"]')?.value.trim() || "";
          itemData.qcQa = getCheckedValues(item, 'input[name^="qc"]', true);
          itemData.qcQaOther = item.querySelector('input[name="qcOther[]"]')?.value.trim() || "";
          itemData.mainUses = getCheckedValues(item, 'input[name^="use"]', true);
          itemData.mainUsesOther = item.querySelector('input[name="useOther[]"]')?.value.trim() || "";
          itemData.remark = item.querySelector('textarea[name="remark[]"]')?.value.trim() || "";
          items.push(itemData);
        });
        return { agency, items };
      }

      function showError(input, message) {
        input.classList.add("border-red-500", "focus:border-red-500", "focus:ring-red-500");
        input.classList.remove("border-slate-300", "focus:border-blue-500", "focus:ring-blue-500");
        const parent = input.parentElement;
        if (!parent.querySelector(".error-text-msg")) {
          const msg = document.createElement("p");
          msg.className = "error-text-msg text-red-500 text-xs mt-1";
          msg.textContent = message;
          parent.appendChild(msg);
        }
      }

      function clearError(input) {
        input.classList.remove("border-red-500", "focus:border-red-500", "focus:ring-red-500");
        input.classList.add("border-slate-300", "focus:border-blue-500", "focus:ring-blue-500");
        const parent = input.parentElement;
        const msg = parent.querySelector(".error-text-msg");
        if (msg) {
          msg.remove();
        }
      }

      function validateFormCustom() {
        let isValid = true;
        let firstInvalidInput = null;
        const requiredInputs = form.querySelectorAll("[required]:not([disabled])");
        requiredInputs.forEach((input) => {
          if (!input.value.trim()) {
            showError(input, "* จำเป็น (โปรดระบุ)");
            isValid = false;
            if (!firstInvalidInput) firstInvalidInput = input;
            input.addEventListener("input", function() {
                clearError(this);
            }, { once: true });
            input.addEventListener("change", function() {
                clearError(this);
            }, { once: true });
          } else {
            clearError(input);
          }
        });
        if (firstInvalidInput) {
          firstInvalidInput.scrollIntoView({ behavior: "smooth", block: "center" });
          firstInvalidInput.focus();
        }
        return isValid;
      }
      
      async function submitToAppsScript(payload) {
        const resp = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
          body: JSON.stringify(payload),
        });
        let data = null;
        try {
          data = await resp.json();
        } catch (e) {
          data = null;
        }
        return data || { success: resp.ok };
      }
      
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (!validateFormCustom()) {
          return; 
        }
        openConfirmModal(
          "ยืนยันการส่งแบบฟอร์ม",
          "โปรดตรวจสอบข้อมูลให้ถูกต้อง ก่อนยืนยันการส่งแบบฟอร์ม",
          async () => {
            const payload = collectFormData();
            try {
              const res = await submitToAppsScript(payload);
              if (res && res.success) {
                openSuccessModal();
              } else {
                alert("บันทึกข้อมูลไม่สำเร็จ กรุณาลองใหม่อีกครั้ง");
              }
              form.reset();
              form.querySelectorAll(".error-text-msg").forEach(e => e.remove());
              form.querySelectorAll(".border-red-500").forEach(e => {
                  e.classList.remove("border-red-500");
                  e.classList.add("border-slate-300");
              });
              const items = demContainer.querySelectorAll(".dem-item");
              items.forEach((item, idx) => {
                if (idx > 0) item.remove();
              });
              const first = demContainer.querySelector(".dem-item");
              if (first) {
                const basinTags = first.querySelector(".basin-tags");
                const provinceTags = first.querySelector(".province-tags");
                if (basinTags) basinTags.innerHTML = "";
                if (provinceTags) provinceTags.innerHTML = "";
                const basinHidden = first.querySelector(".basin-other-input");
                const provinceHidden = first.querySelector(".province-other-input");
                if (basinHidden) basinHidden.value = "";
                if (provinceHidden) provinceHidden.value = "";
                const basinBlock = first.querySelector(".basin-block");
                const provinceBlock = first.querySelector(".province-block");
                const localBlock = first.querySelector(".local-block");
                if (basinBlock) basinBlock.classList.add("hidden");
                if (provinceBlock) provinceBlock.classList.add("hidden");
                if (localBlock) localBlock.classList.add("hidden");
                const localInput = first.querySelector(".local-input");
                if (localInput) {
                    localInput.value = "";
                    localInput.disabled = true;
                    localInput.required = false; 
                    clearError(localInput);
                }
                attachOtherFieldHandlers(first);
              }
              populateYearSelects();
              updateDemIndexes();
              applyReferenceDataToAllItems();
            } catch (err) {
              console.error("submitDemSurvey error", err);
              alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล โปรดลองอีกครั้ง");
            }
          }
        );
      });
    </script>
  </body>
</html>
